---
- hosts: all
  become: true
  vars:
    nginx_version: stable
  tasks:

    - name: Install pip
      yum:
        name: python3-pip
        state: present
    - name: Install ansible
      pip:
        name: ansible
        state: present

    # - name: Set version variable
    #   set_fact:
    #     version: 1.20.2-1

    # - name: Add nginx repository
    #   yum_repository:
    #     name: nginx
    #     description: nginx repository
    #     baseurl: https://nginx.org/packages/centos/9/x86_64/RPMS/
    #     gpgcheck: yes
    #     gpgkey: https://nginx.org/keys/nginx_signing.key
    # - name: Install nginx
    #   yum:
    #     name: nginx
    #     state: present
    # - name: Start nginx
    #   service:
    #     name: nginx
    #     state: started
    #     enabled: true

    # - name: Install nginx role from galaxy
    #   ansible.builtin.galaxy_role:
    #     name: nginxinc.nginx
    #     state: present

    # - name: Start and enable nginx
    #   service:
    #     name: nginx
    #     state: started
    #     enabled: true

  # - name: Install ansible using pip
  #   pip:
  #     name: ansible
  #     state: present
  
  # Install & Configure Nginx     
  # - name: Install nginx
  #   yum:
  #     name: nginx
  #     state: present
  # - name: Start and enable Nginx
  #   service:
  #     name: nginx
  #     state: started
  #     enabled: true

    # - name: Start and enable NGINX service
    #   service:
    #     name: nginx
    #     state: started
    #     enabled: true
    #   tags:
    #     - service

    - name: Create sites-enabled directory
      file:
        path: /etc/nginx/sites-enabled
        state: directory

    - name: Create site configuration
      template:
        src: site.conf.j2
        dest: /etc/nginx/sites-enabled/site.conf
        owner: root
        group: root
        mode: 0644
    - name: Restart Nginx
      service:
        name: nginx
        state: restarted


    - name: Install git
      yum:
        name: git
        state: present

    # - name: Add git credentials
    #   shell: |
    #     git config --global user.name "{{ git_user_name }}"
    #     git config --global user.email "{{ git_user_email }}"
    #     git config --global credential.helper "cache --timeout=360000"
    #     echo "https://{{ git_user_name }}:{{ git_user_password }}@github.com" | git credential approve
    #   args:
    #     executable: /bin/bash
    #   vars:
    #     git_user_name: "MohamedRagabAnas"
    #     git_user_email: "mohamed.ragab@nub.edu.eg"
    #     git_user_password: "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"

    - name: Install Docker
      yum:
        name: docker
        state: present
      tags:
        - docker

    - name: Add the ec2-user to the docker group
      user:
        name: ec2-user
        groups: docker
        append: yes
      tags:
        - docker

    - name: Start the Docker service
      service:
        name: docker
        state: started
        enabled: yes
      tags:
        - docker

    
    - name: Install docker-compose
      pip:
        name: docker-compose
        state: present
      tags:
        - docker-compose

    - name: Create a directory for Kong
      file:
        path: /opt/kong
        state: directory
      tags:
        - kong

    - name: Create a docker-compose file for Kong
      copy:
        src: docker-compose.yml
        dest: /opt/kong/docker-compose.yml
      tags:
        - kong

    - name: Run Kong using docker-compose
      command: /usr/local/bin/docker-compose -f /opt/kong/docker-compose.yml up -d
      args:
        chdir: /opt/kong
      tags:
        - kong

    - name: Start the Kong container
      shell: /usr/local/bin/docker-compose start kong
      args:
        chdir: /opt/kong
      tags:
        - kong
    
    - name: Install tkinter
      yum: 
        name: python3-tkinter.x86_64
        state: present
